rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Allow admins to fully manage the stations collection.
    // The 'read' rule covers both 'get' (single document) and 'list' (collection query).
    match /stations/{stationId} {
      allow read, write: if request.auth.token.admin == true;
    }

    // Allow any authenticated user to create/update their own medical info.
    // Deny access to other users' data.
    match /medicalInfo/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Allow any authenticated user to create alerts.
    // Allow admins to read and update all alerts.
    // Users can read/update their own alerts (e.g., to cancel).
    match /alerts/{alertId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth.token.admin == true || request.auth.uid == resource.data.userId;
      // Admins have full delete rights.
      allow delete: if request.auth.token.admin == true;
    }

    // Allow admins to manage user roles and data.
    // Allow any authenticated user to see the list of users for initial admin setup.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.admin == true;
    }
  }
}
