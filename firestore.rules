
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regla General: Por defecto, nadie puede acceder a nada.
    match /{document=**} {
      allow read, write: if false;
    }

    // --- REGLAS PARA USUARIOS DE LA APP MÓVIL ---

    // Colección medicalInfo:
    // Un usuario puede crear y actualizar su propia información médica.
    // Solo el propio usuario puede leer su información.
    match /medicalInfo/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Colección alerts:
    // Cualquier usuario autenticado (incluidos anónimos) puede crear una alerta.
    match /alerts/{alertId} {
      allow create: if request.auth != null;

      // LA CORRECCIÓN CLAVE ESTÁ AQUÍ:
      // Un usuario puede LEER una alerta si su UID coincide con el userId de la alerta.
      // Esto permite que la página de "Historial de Alertas" funcione.
      // También permite la lectura si el usuario es un admin o una unidad asignada.
      allow read: if request.auth.uid == resource.data.userId
                   || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
                   || request.auth.uid == resource.data.assignedUnitId;

      // Un usuario puede ACTUALIZAR (cancelar) una alerta si es el dueño
      // y si el nuevo estado es 'cancelled'.
      // También permitimos que un admin o una unidad actualicen la alerta.
      allow update: if (request.auth.uid == resource.data.userId && request.resource.data.status == 'cancelled')
                      || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
                      || request.auth.uid == resource.data.assignedUnitId;
    }


    // --- REGLAS PARA USUARIOS DEL PANEL DE ADMINISTRACIÓN ---

    // Colección users (perfiles de operadores/admins):
    // Solo los administradores pueden leer y escribir en esta colección.
    match /users/{userId} {
      allow read, write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Colección stations y subcolección de unidades:
    // Solo los administradores pueden gestionar estaciones y unidades.
    match /stations/{stationId}/{document=**} {
        allow read, write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
