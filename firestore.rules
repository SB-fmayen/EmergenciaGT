
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Regla para perfiles de usuario del panel (operadores/admins)
    // - Un usuario puede crear su propio perfil.
    // - Un usuario puede leer y actualizar su propio perfil.
    match /users/{userId} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Regla para estaciones de bomberos
    // - Solo los administradores pueden leer y escribir estaciones y sus unidades.
    match /stations/{stationId} {
      allow read, write: if request.auth.token.admin == true;

      match /unidades/{unitId} {
        allow read, write: if request.auth.token.admin == true;
      }
    }

    // Regla para la información médica de los usuarios de la app móvil
    // - Un usuario puede escribir su propia información médica.
    // - Cualquier usuario autenticado en el sistema (operadores/admins) puede leerla.
    match /medicalInfo/{userId} {
      allow write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null;
    }

    // Regla para las alertas de emergencia
    match /alerts/{alertId} {
      // Cualquier usuario (incluido anónimo) puede crear una alerta.
      allow create: if request.auth != null;
      
      // Un usuario puede leer o actualizar una alerta si es un admin,
      // O si la alerta está asignada a la estación de ese operador.
      allow read, update: if request.auth.token.admin == true || 
                           (resource.data.assignedStationId == request.auth.token.stationId);
    }
  }
}

    