rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Regla para la colección de usuarios del panel
    match /users/{userId} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Regla para la colección de estaciones y sus unidades
    match /stations/{stationId} {
      allow read, write: if request.auth != null && request.auth.token.admin == true;

      // Unidades dentro de cada estación
      match /unidades/{unitId} {
        allow read, write: if request.auth.token.admin == true;
      }
    }
    
    // Regla para la información médica de los usuarios de la app
    match /medicalInfo/{userId} {
      // El dueño del perfil puede escribirlo
      allow write: if request.auth != null && request.auth.uid == userId;
      // Cualquier usuario autenticado en el sistema (operadores/admins) puede leerlo para una emergencia
      allow read: if request.auth != null;
    }
    
    // REGLA DE ALERTAS CORREGIDA
    match /alerts/{alertId} {
      // PERMISOS PARA DOCUMENTOS INDIVIDUALES
      // Un admin o un operador de la estación asignada pueden obtener/actualizar una alerta específica.
      // El usuario que la creó también puede leerla y actualizarla (para cancelarla).
      allow get, update: if request.auth != null && (
                           request.auth.token.admin == true || 
                           resource.data.assignedStationId == request.auth.token.stationId ||
                           request.auth.uid == resource.data.userId
                         );
                         
      // PERMISOS PARA LISTAS (QUERIES)
      // Esta es la regla clave que soluciona el error PERMISSION_DENIED.
      allow list: if request.auth != null && (
                    // Un admin puede listar todas las alertas.
                    request.auth.token.admin == true ||
                    // Un operador puede listar alertas SI Y SOLO SI la consulta filtra por su ID de estación.
                    request.query.where.assignedStationId == request.auth.token.stationId
                  );

      // PERMISO DE CREACIÓN
      // Cualquier usuario (registrado o anónimo) puede crear una alerta.
      allow create: if request.auth != null;
    }
  }
}
